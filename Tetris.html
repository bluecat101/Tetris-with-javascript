<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>Tetris</title>
  <!-- <script type="text/javascript" src="Tetris.js"></script> -->
  <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
  <!-- <script src="jquery.pause.js"></script> -->
  <link rel="stylesheet" href="Tetris.css">

</head>

<body>
  <!-- <div id="start">
    <button id="start_button" type="button" onclick="start()">START</button>
  </div> -->
  <!-- <canvas id="myCanvas"></canvas> -->
  <script>

    // var canvas = document.getElementById("myCanvas").getContext("2d");

    //
    // 前準備。
    //

    var i;
    var bgy = 0;
    const width = 350;
    const height = 600;
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');
    document.body.appendChild(canvas);
    canvas.width = width;
    canvas.height = height;

    var mino_place = [];
    var terrain_data = Array(240);
    terrain_data_length = terrain_data.length - 10;
    terrain_data.fill(0);
    terrain_data[220] = 3;
    terrain_data[219] = 3;

    //-------------------------
    for (i = 170; i < 200; i++) {
      terrain_data[i] = 6;
    }
    for (i = 200; i < 210; i++) {
      terrain_data[i] = 4;
    }
    //---------------------------
    for (i = 230; i < 240; i++) {
      terrain_data[i] = 8;
    }
    var flag_down = 0;
    var check_row_number = 0;
    var rotate_number = 0;
    make_mino();
    loop();

    function loop() {
      context.clearRect(0, 0, width, height);
      background();
      for (const mp of mino_place) {
        terrain_data[mp.position] = mp.kinds;
      }
      display();
      bgy += 1;
      if (bgy > 10) {//描写速度
        bgy = 0;
        check_flag_down();
        if (flag_down == 0) {
          for (const mp of mino_place) {
            terrain_data[mp.position] = 0
            mp.position += 10;
          }
        } else {
          flag_down = 0;
          check_row();
          // delete_row();
          make_mino();
        }
      }
      window.requestAnimationFrame(loop);
    }

    document.addEventListener('keydown', function (e) {
      if (e.code == 'ArrowLeft' && check_flag_left() == 0) {
        for (const mp of mino_place) {
          terrain_data[mp.position] = 0
          mp.position -= 1;
        }
      } else if (e.code == 'ArrowRight' && check_flag_right() == 0) {
        for (const mp of mino_place) {
          terrain_data[mp.position] = 0
          mp.position += 1;
        }
      } else if (e.code == 'KeyQ') {

      }
    })

    function check_flag_down() {
      for (var mp of mino_place) {
        if (terrain_data[mp.position + 10] != 0 && mp.position + 10 != mino_place[0].position && mp.position + 10 != mino_place[1].position && mp.position + 10 != mino_place[2].position && mp.position + 10 != mino_place[3].position) {
          flag_down = 1;
        }
      }
    }
    function check_flag_right() {
      for (var mp of mino_place) {
        if (mp.position % 10 == 9 || (terrain_data[mp.position + 1] != 0 && mp.position + 1 != mino_place[0].position && mp.position + 1 != mino_place[1].position && mp.position + 1 != mino_place[2].position && mp.position + 1 != mino_place[3].position)) {
          return 1;
        }
      }
      return 0;
    }
    function check_flag_left() {
      for (var mp of mino_place) {
        if (mp.position % 10 == 0 || (terrain_data[mp.position - 1] != 0 && mp.position - 1 != mino_place[0].position && mp.position - 1 != mino_place[1].position && mp.position - 1 != mino_place[2].position && mp.position - 1 != mino_place[3].position)) {
          return 1;
        }
      }
      return 0;
    }

    function make_mino() {
      mino_place.splice(0);
      var rand = Math.floor(Math.random() * 7) + 1
      switch (rand) {
        case 1:
          mino_place.push({ kinds: 1, position: 3 });
          mino_place.push({ kinds: 1, position: 4 });
          mino_place.push({ kinds: 1, position: 5 });
          mino_place.push({ kinds: 1, position: 6 });
          break;
        case 2:
          mino_place.push({ kinds: 2, position: 4 });
          mino_place.push({ kinds: 2, position: 5 });
          mino_place.push({ kinds: 2, position: 14 });
          mino_place.push({ kinds: 2, position: 15 });
          break;
        case 3:
          mino_place.push({ kinds: 3, position: 5 });
          mino_place.push({ kinds: 3, position: 13 });
          mino_place.push({ kinds: 3, position: 14 });
          mino_place.push({ kinds: 3, position: 15 });
          break;
        case 4:
          mino_place.push({ kinds: 4, position: 3 });
          mino_place.push({ kinds: 4, position: 13 });
          mino_place.push({ kinds: 4, position: 14 });
          mino_place.push({ kinds: 4, position: 15 });
          break;
        case 5:
          mino_place.push({ kinds: 5, position: 4 });
          mino_place.push({ kinds: 5, position: 5 });
          mino_place.push({ kinds: 5, position: 14 });
          mino_place.push({ kinds: 5, position: 13 });
          break;

        case 6:
          mino_place.push({ kinds: 6, position: 3 });
          mino_place.push({ kinds: 6, position: 4 });
          mino_place.push({ kinds: 6, position: 14 });
          mino_place.push({ kinds: 6, position: 15 });;
          break;
        case 7:
          mino_place.push({ kinds: 7, position: 4 });
          mino_place.push({ kinds: 7, position: 13 });
          mino_place.push({ kinds: 7, position: 14 });
          mino_place.push({ kinds: 7, position: 15 });
          break;
      }
    }
    // function rotate_right() {
    //   if (check_flag_right == 0) {
    //     for (var mp of mino_place) {
    //       switch (mp.position - mino_place[0].position) {
    //         case -11, -10:
    //           mp.position += 1;
    //           break;
    //         case -9, 1:
    //           mp.position += 10;
    //           break;
    //         case 11, 10:
    //           mp.position += -1;

    //           break;
    //         case 9, -1:
    //           mp.position += -10;
    //           break;
    //       }
    //     }
    //   }

    // }

    // function rotate_left() {
    //   if (check_flag_left == 0) {
    //     for (var mp of mino_place) {
    //       switch (mp.position - mino_place[0].position) {
    //         case -10, -9:
    //           mp.position += -1;
    //           break;
    //         case -11, -1:
    //           mp.position += 10;
    //           break;
    //         case 9, 10:
    //           mp.position += 1;

    //           break;
    //         case 11, 1:
    //           mp.position += -10;
    //           break;
    //       }
    //     }
    //   }
    // }


    function check_row() {//delete and shift
      for (var i = 1; i < terrain_data_length / 10; i++) {
        check_row_number = 0;
        for (var j = 0; j < 10; j++) {
          if (terrain_data[i * 10 + j] != 0) {
            check_row_number += 1;
          }
        }
        if (check_row_number == 10) {
          for (var j = 0; j < 10; j++) {
            terrain_data[i * 10 + j] = 0;
          }
          shift(i);
        }
      }
    }
    function shift(shift_row) {
      for (var j = shift_row * 10 - 1; j >= 0; j--) {
        terrain_data[j + 10] = terrain_data[j];
      }

    }
    function display() {
      for (i = 0; i < terrain_data_length; i++) {
        x = Math.floor(i % 10) * 20 + 80;
        y = Math.floor(i / 10) * 20 + 100 - 20;
        switch (terrain_data[i]) {
          case 0:
            context.fillStyle = 'rgba(0, 0, 0,0)';
            break;
          case 1:
            context.fillStyle = 'rgb(0, 255, 255)';
            break;
          case 2:
            context.fillStyle = 'rgb(255, 255, 0)';
            break;
          case 3:
            context.fillStyle = 'rgb(255, 165, 0)';
            break;
          case 4:
            context.fillStyle = 'rgb(0, 0, 255)';
            break;
          case 5:
            context.fillStyle = 'rgb(0, 255, 0)';
            break;
          case 6:
            context.fillStyle = 'rgb(255, 0, 0)';
            break;
          case 7:
            context.fillStyle = 'rgb(128, 0, 128)';
            break;
        }
        context.fillRect(x, y, 20, 20);
      }
    }
    function background() {
      let i;
      for (i = 0; i <= 10; i++) {
        context.moveTo(80 + i * 20, 100);
        context.lineTo(80 + i * 20, 540);
      }
      for (i = 0; i < 22; i++) {
        context.moveTo(80, 100 + i * 20);
        context.lineTo(280, 100 + i * 20);
      }
      context.strokeStyle = "rgba(0,0,0,0.3)";
      context.lineWidth = 1;
      context.stroke();
      context.beginPath();
      context.rect(80, 100, 200, 440)
      context.strokeStyle = "rgba(0,0,0,1)";
      context.lineWidth = 2;
      context.stroke();
    }
  </script>
  <div>
    <p>

      左上:80,100<br>
      右上:280,100<br>
      左下:280,540<br>
      右下:80,540<br>
      幅:20<br>
      1:I字-水色<br>
      2:O字-黄色<br>
      3:L字-オレンジ<br>
      4:逆L字-青<br>
      5:緑<br>
      6:赤<br>
      7:T字-紫<br>
      8:外部<br>
    </p>
  </div>
</body>

</html>
