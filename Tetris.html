<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>Tetris</title>
  <!-- <script type="text/javascript" src="Tetris.js"></script> -->
  <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
  <!-- <script src="jquery.pause.js"></script> -->
  <link rel="stylesheet" href="Tetris.css">

</head>

<body>
  <!-- <div id="start">
    <button id="start_button" type="button" onclick="start()">START</button>
  </div> -->
  <!-- <canvas id="myCanvas"></canvas> -->
  <script>

    // var canvas = document.getElementById("myCanvas").getContext("2d");

    //
    // 前準備。
    //
    var i;
    var bgy = 100;
    const width = 350;
    const height = 600;
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');
    document.body.appendChild(canvas);
    canvas.width = width;
    canvas.height = height;

    var mino_place = [];
    var terrain_data = Array(240);
    terrain_data_length = terrain_data.length;
    terrain_data.fill(0);
    terrain_data[220] = 3;
    terrain_data[210] = 3;
    terrain_data[190] = 3;

    terrain_data[180] = 3;
    terrain_data[170] = 3;
    terrain_data[219] = 3;
    terrain_data[209] = 3;
    terrain_data[169] = 3;
    for (i = 230; i < 240; i++) {
      terrain_data[i] = 8;
    }
    var flag_down = 0;
    add_mino();

    function add_mino() {
      mino_place.push({ kinds: 5, position: 4 });
      mino_place.push({ kinds: 5, position: 5 });

      mino_place.push({ kinds: 5, position: 14 });
      mino_place.push({ kinds: 5, position: 13 });
      loop();
    }

    function loop() {
      context.clearRect(0, 0, width, height);
      background();
      for (const mp of mino_place) {
        terrain_data[mp.position] = mp.kinds;
      }
      display();
      // flag_down();
      bgy += 1;
      if (bgy > 10) {//描写速度
        bgy = 0;
        check_flag_down();
        for (const mp of mino_place) {
          if (flag_down == 0) {
            terrain_data[mp.position] = 0
            mp.position += 10;
          } else {
            flag_down = 0;
            console.log(mino_place[0]);
            console.log(mino_place[1]);
            for (i = 10; i < 230; i++) {
              if (terrain_data[i] != 0) {
                console.log(i);
              }
            }
            mino_place.pop();
            mino_place.pop();
            mino_place.pop();
            mino_place.pop();
            // add_mino();
          }
        }
      }
      window.requestAnimationFrame(loop);
    }




    document.addEventListener('keydown', function (e) {
      if (e.code == 'ArrowLeft' && check_flag_left() == 0) {
        for (const mp of mino_place) {
          terrain_data[mp.position] = 0
          mp.position -= 1;
        }
      } else if (e.code == 'ArrowRight' && check_flag_right() == 0) {
        for (const mp of mino_place) {
          terrain_data[mp.position] = 0
          mp.position += 1;
        }
      }
    })

    function check_flag_down() {
      for (var mp of mino_place) {
        if (terrain_data[mp.position + 10] != 0 && mp.position + 10 != mino_place[0].position && mp.position + 10 != mino_place[1].position && mp.position + 10 != mino_place[2].position && mp.position + 10 != mino_place[3].position) {
          flag_down = 1;
        }
      }
    }
    function check_flag_right() {
      for (var mp of mino_place) {
        if (mp.position % 10 == 9 || (terrain_data[mp.position + 1] != 0 && mp.position + 1 != mino_place[0].position && mp.position + 1 != mino_place[1].position && mp.position + 1 != mino_place[2].position && mp.position + 1 != mino_place[3].position)) {
          return 1;
        }
      }
      return 0;
    }
    function check_flag_left() {
      for (var mp of mino_place) {
        if (mp.position % 10 == 0 || (terrain_data[mp.position - 1] != 0 && mp.position - 1 != mino_place[0].position && mp.position - 1 != mino_place[1].position && mp.position - 1 != mino_place[2].position && mp.position - 1 != mino_place[3].position)) {
          return 1;
        }
      }
      return 0;
    }
    function display() {
      for (i = 0; i < terrain_data_length; i++) {
        x = Math.floor(i % 10) * 20 + 80;
        y = Math.floor(i / 10) * 20 + 100 - 20;
        // console.log(terrain_data[i], x, y);
        switch (terrain_data[i]) {
          case 0:
            context.fillStyle = 'rgba(0, 0, 0,0)';
            break;
          case 1:
            context.fillStyle = 'rgb(0, 255, 255)';
            break;
          case 2:
            context.fillStyle = 'rgb(255, 255, 0)';
            break;
          case 3:
            context.fillStyle = 'rgb(255, 165, 0)';
            break;
          case 4:
            context.fillStyle = 'rgb(0, 0, 255)';
            break;
          case 5:
            context.fillStyle = 'rgb(0, 255, 0)';
            break;
          case 6:
            context.fillStyle = 'rgb(255, 0, 0)';
            break;
          case 7:
            context.fillStyle = 'rgb(128, 0, 128)';
            break;
        }
        context.fillRect(x, y, 20, 20);
      }
    }
    function background() {
      let i;
      for (i = 0; i <= 10; i++) {
        context.moveTo(80 + i * 20, 100);
        context.lineTo(80 + i * 20, 540);
      }
      for (i = 0; i < 22; i++) {
        context.moveTo(80, 100 + i * 20);
        context.lineTo(280, 100 + i * 20);
      }
      context.strokeStyle = "rgba(0,0,0,0.3)";
      context.lineWidth = 1;
      context.stroke();
      context.beginPath();
      context.rect(80, 100, 200, 440)
      context.strokeStyle = "rgba(0,0,0,1)";
      context.lineWidth = 2;
      context.stroke();
    }
  </script>
  <div>
    <p>
      内部的思考は1px,表現のみ20px<br>
      左上:80,100<br>
      右上:280,100<br>
      左下:280,540<br>
      右下:80,540<br>
      幅:20<br>
      1:I字-水色<br>
      2:O字-黄色<br>
      3:L字-オレンジ<br>
      4:逆L字-青<br>
      5:緑<br>
      6:赤<br>
      7:T字-紫<br>
      8:外部<br>
    </p>
  </div>
</body>

</html>
